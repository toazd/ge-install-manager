#!/usr/bin/env bash

tmp_file=/tmp/geimTests.proton-ge-custom.releases
log_file=geimLog_$(date '+%F_%T').log
debug_log=geimDebugLog_$(date '+%F_%T').log
notes_log=geimReleaseNotes_$(date '+%F_%T').log

rm -vf "$tmp_file" "$log_file" "$debug_log" "$notes_log"

touch "$tmp_file" "$log_file" "$debug_log" "$notes_log" || exit 1

CleanUp () {
    rm -vf "$tmp_file"
    unset GEIM_TESTS
}

trap 'CleanUp' EXIT

# Disable color escape codes in script stderr verbose output
export GEIM_TESTS=1

# Log the output of ReportEnvironmentInfo()
ge-install-manager -fzZ 1>"$log_file" 2>>"$debug_log"

# Log the output of ShowHelp and ShowUsage
##ge-install-manager -hH >> "$log_file"

# Log the output of checkforupdate
ge-install-manager -zu 1>>"$log_file" 2>>"$debug_log"

# File count and disk usage and list installed versions
ge-install-manager -lS 1>>"$log_file" 2>>"$debug_log"

# Get a list of the available releases
# Parse ge-install-manager -l output into a tmp file
while IFS= read -r; do
    REPLY=${REPLY%%[[:blank:]]*}
    REPLY=${REPLY//Proton-}
    printf '%s\n' "$REPLY"
done < <(ge-install-manager -L) >>"$tmp_file"

# shellcheck disable=SC2129
printf '\n%s\n%s\n%s\n%s\n' \
       "Releases available:" "$(cat "$tmp_file")" \
       "Installed releases:" "$(ge-install-manager -zl)" 1>>"$log_file" 2>>"$debug_log"

Test1_UninstallDownloadInstallVerifyRemove () {

    # Remove all previously installed files
    ##ge-install-manager -fXD
    # Remove all but saved packages
    ##ge-install-manager -fD

    # Download each available release version
    while IFS= read -r; do
        ge-install-manager -zd "$REPLY" 1>/dev/null
    done <"$tmp_file"

    # Install each available release version
    while IFS= read -r; do
        ge-install-manager -zi "$REPLY" 1>/dev/null
    done <"$tmp_file"

    # Verify the installs
    Test2_Verify

    # Report disk usage
    ge-install-manager -zSl "$REPLY"

    # Remove only installs
    while IFS= read -r; do
        ge-install-manager -zR "$REPLY"
    done <"$tmp_file"

    # Install each
    while IFS= read -r; do
        ge-install-manager -zi "$REPLY"
    done <"$tmp_file"

    # Report disk usage
    ge-install-manager -zSl "$REPLY"

} 1>>"$log_file" 2>>"$debug_log"

Test2_Verify () {

    # Verify all installations at once
    ge-install-manager -zV 1>/dev/null

    # Verify all installations one at a time
    while IFS= read -r; do
        ge-install-manager -zv "$REPLY" 1>/dev/null
    done <"$tmp_file"

} 1>>"$log_file" 2>>"$debug_log"

Test3_ReleaseNotes () {

    # Show release notes one at a time
    while IFS= read -r; do
        ge-install-manager -zn "$REPLY"
    done <"$tmp_file"

    # Show release notes all at once
    ge-install-manager -zN

} 1>>"$notes_log" 2>>"$debug_log"

Test4_FileCountDiskUsage () {

    # Report file count and disk usage one at a time
    while IFS= read -r; do
        ge-install-manager -zs "$REPLY"
    done <"$tmp_file"

    # Report file count and disk usage all at once
    ge-install-manager -zS

} 1>>"$log_file" 2>>"$debug_log"

##Test1_UninstallDownloadInstallVerifyRemove # Test1 runs Test2_Verify

Test3_ReleaseNotes

Test4_FileCountDiskUsage
